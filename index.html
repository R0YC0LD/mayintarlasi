<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Professional Farm Sim - JS Edition</title>
    <style>
        /* CSS RESET & TEMEL AYARLAR */
        * { box-sizing: border-box; touch-action: none; /* Mobilde varsayƒ±lan kaydƒ±rmayƒ± kapatƒ±r */ user-select: none; -webkit-user-select: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #2c3e50; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* OYUN ALANI */
        #gameContainer { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; background: #8fbc8f; }
        canvas { box-shadow: 0 10px 30px rgba(0,0,0,0.5); border-radius: 4px; background: #90EE90; }

        /* KULLANICI ARAY√úZ√ú (UI) KATMANI */
        #uiLayer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; /* Tƒ±klamalar canvas'a ge√ßsin */ }
        
        .hud-panel { position: absolute; pointer-events: auto; background: rgba(255, 255, 255, 0.9); border: 2px solid #5d4037; border-radius: 12px; padding: 10px; display: flex; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        
        /* √úst Bar: Level, Coin, XP */
        #topBar { top: 10px; left: 10px; right: 10px; height: 60px; justify-content: space-between; font-weight: bold; color: #3e2723; }
        .stat-box { display: flex; flex-direction: column; align-items: center; min-width: 60px; }
        .stat-value { font-size: 1.2rem; color: #d35400; }
        .stat-label { font-size: 0.7rem; color: #795548; }

        /* Alt Bar: Ara√ßlar ve Market */
        #bottomBar { bottom: 10px; left: 10px; right: 10px; height: 80px; justify-content: center; gap: 10px; background: transparent; border: none; box-shadow: none; }
        .tool-btn { width: 64px; height: 64px; background: #fff; border: 3px solid #795548; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 32px; cursor: pointer; transition: transform 0.1s; box-shadow: 0 4px 0 #5d4037; pointer-events: auto; }
        .tool-btn:active { transform: translateY(4px); box-shadow: 0 0 0 #5d4037; }
        .tool-btn.active { background: #ffe0b2; border-color: #e65100; transform: scale(1.1); }

        /* Context Menu (Tarlaya tƒ±klayƒ±nca √ßƒ±kan) */
        #contextMenu { position: absolute; display: none; background: rgba(255,255,255,0.95); padding: 10px; border-radius: 50px; border: 2px solid #333; pointer-events: auto; gap: 10px; transform: translate(-50%, -100%); transition: opacity 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .ctx-item { width: 50px; height: 50px; border-radius: 50%; background: #eee; border: 2px solid #aaa; display: flex; justify-content: center; align-items: center; font-size: 24px; cursor: pointer; }

        /* Market Modal */
        #marketModal { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; max-width: 400px; background: #fffaf0; border: 4px solid #8d6e63; border-radius: 15px; padding: 20px; pointer-events: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.5); z-index: 100; }
        .market-header { text-align: center; font-size: 1.5rem; color: #3e2723; margin-bottom: 15px; border-bottom: 2px dashed #ccc; padding-bottom: 10px; }
        .market-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .market-item { background: #fff; border: 1px solid #ddd; padding: 10px; border-radius: 8px; text-align: center; cursor: pointer; }
        .market-item:active { background: #eee; }
        .btn-close { display: block; width: 100%; padding: 10px; margin-top: 15px; background: #e74c3c; color: white; text-align: center; border: none; border-radius: 5px; font-weight: bold; }
        
        /* Bildirimler (Toast) */
        #toastArea { position: absolute; top: 80px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; gap: 5px; pointer-events: none; }
        .toast { background: rgba(0,0,0,0.7); color: white; padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; animation: fadeOut 2s forwards; }
        @keyframes fadeOut { 0% { opacity: 1; transform: translateY(0); } 80% { opacity: 1; transform: translateY(-10px); } 100% { opacity: 0; } }
    </style>
</head>
<body>

<div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
    <div id="uiLayer">
        <div id="topBar" class="hud-panel">
            <div class="stat-box"><span class="stat-label">LEVEL</span><span id="uiLevel" class="stat-value">1</span></div>
            <div class="stat-box"><span class="stat-label">XP</span><span id="uiXp" class="stat-value">0/100</span></div>
            <div class="stat-box"><span class="stat-label">COIN</span><span id="uiCoin" class="stat-value">0</span></div>
            <div class="stat-box"><span class="stat-label">SILO</span><span id="uiSilo" class="stat-value">0/20</span></div>
        </div>
        
        <div id="contextMenu"></div>

        <div id="marketModal">
            <div class="market-header">üõí √áƒ∞FT√áƒ∞ MARKETƒ∞</div>
            <div id="marketContent" class="market-grid">
                </div>
            <button class="btn-close" onclick="uiManager.toggleMarket(false)">Kapat</button>
        </div>

        <div id="toastArea"></div>

        <div id="bottomBar" class="hud-panel">
            <div class="tool-btn" id="btnShop" onclick="uiManager.toggleMarket(true)">üè™</div>
            </div>
    </div>
</div>

<script>
/**
 * PART 1: YARDIMCI SINIFLAR & SABƒ∞TLER
 */

// Oyun Sabitleri
const CONFIG = {
    TILE_SIZE: 64, // Piksel cinsinden kare boyutu
    GRID_ROWS: 10,
    GRID_COLS: 8,
    OFFLINE_GROWTH: true, // Oyun kapalƒ±yken b√ºy√ºme
    AUTOSAVE_INTERVAL: 5000 // 5 saniyede bir kayƒ±t
};

// Ekin Veritabanƒ± (Crop Manager Logic)
const CROPS = {
    WHEAT: { id: 'wheat', name: 'Buƒüday', symbol: 'üåæ', growthTime: 5000, cost: 0, sellPrice: 2, xp: 1 },
    CORN:  { id: 'corn',  name: 'Mƒ±sƒ±r',  symbol: 'üåΩ', growthTime: 10000, cost: 2, sellPrice: 5, xp: 3 },
    CARROT:{ id: 'carrot',name: 'Havu√ß',  symbol: 'ü•ï', growthTime: 20000, cost: 5, sellPrice: 12, xp: 6 },
    PUMPKIN:{id: 'pumpkin',name:'Balkabaƒüƒ±',symbol:'üéÉ', growthTime: 45000, cost: 10,sellPrice: 30, xp: 12 }
};

// 1. INPUT MANAGER (Dokunmatik ve Mouse Birle≈ütirici)
class InputManager {
    constructor(canvas) {
        this.canvas = canvas;
        this.isDragging = false;
        this.activePointer = { x: 0, y: 0 };
        this.dragStartPos = { x: 0, y: 0 };
        this.listeners = [];

        // Olaylarƒ± baƒüla
        ['mousedown', 'touchstart'].forEach(evt => canvas.addEventListener(evt, e => this.handleStart(e), {passive: false}));
        ['mousemove', 'touchmove'].forEach(evt => canvas.addEventListener(evt, e => this.handleMove(e), {passive: false}));
        ['mouseup', 'touchend', 'mouseleave'].forEach(evt => canvas.addEventListener(evt, e => this.handleEnd(e)));
    }

    getPointerPos(e) {
        const rect = this.canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        // Canvas scale fakt√∂r√ºn√º hesaba kat
        const scaleX = this.canvas.width / rect.width;
        const scaleY = this.canvas.height / rect.height;
        return {
            x: (clientX - rect.left) * scaleX,
            y: (clientY - rect.top) * scaleY
        };
    }

    handleStart(e) {
        e.preventDefault(); // Mobilde scrolu engelle
        this.isDragging = true;
        this.activePointer = this.getPointerPos(e);
        this.dragStartPos = { ...this.activePointer };
        this.emit('start', this.activePointer);
    }

    handleMove(e) {
        e.preventDefault();
        if(!this.isDragging) return;
        this.activePointer = this.getPointerPos(e);
        this.emit('drag', this.activePointer);
    }

    handleEnd(e) {
        this.isDragging = false;
        this.emit('end', this.activePointer);
    }

    on(event, callback) {
        this.listeners.push({ event, callback });
    }

    emit(event, data) {
        this.listeners.filter(l => l.event === event).forEach(l => l.callback(data));
    }
}

// 2. SAVE SYSTEM (LocalStorage Wrapper)
class SaveSystem {
    static save(key, data) {
        try {
            localStorage.setItem(key, JSON.stringify(data));
        } catch(e) { console.error("Save Hatasƒ±:", e); }
    }
    static load(key) {
        try {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : null;
        } catch(e) { return null; }
    }
}
</script><script>
/**
 * PART 2: OYUN MANTIK KATMANI (GAME LOGIC)
 */

// 3. OYUNCU ENVANTERƒ∞ VE DURUMU
class PlayerState {
    constructor() {
        this.level = 1;
        this.xp = 0;
        this.maxXp = 100;
        this.coins = 50; // Ba≈ülangƒ±√ß parasƒ±
        this.silo = { current: 0, max: 20, items: {} }; // Ekin deposu
        
        // Ba≈ülangƒ±√ß itemleri
        this.addItem('wheat', 5); 
    }

    addItem(itemId, amount) {
        if (this.silo.current + amount > this.silo.max) return false;
        if (!this.silo.items[itemId]) this.silo.items[itemId] = 0;
        this.silo.items[itemId] += amount;
        this.silo.current += amount;
        uiManager.updateUI(); // UI g√ºncelle
        return true;
    }

    removeItem(itemId, amount) {
        if (!this.silo.items[itemId] || this.silo.items[itemId] < amount) return false;
        this.silo.items[itemId] -= amount;
        this.silo.current -= amount;
        uiManager.updateUI();
        return true;
    }

    addXp(amount) {
        this.xp += amount;
        if(this.xp >= this.maxXp) {
            this.level++;
            this.xp -= this.maxXp;
            this.maxXp = Math.floor(this.maxXp * 1.5);
            uiManager.showToast(`üéâ TEBRƒ∞KLER! LEVEL ${this.level}`);
        }
        uiManager.updateUI();
    }
}

// 4. TILE CLASS (Her bir tarla karesi)
class Tile {
    constructor(row, col) {
        this.row = row;
        this.col = col;
        this.state = 'EMPTY'; // EMPTY, PLOWED, SEEDED
        this.cropId = null;
        this.plantTime = 0;
        this.isLocked = false; // ƒ∞leride arsa geni≈ületme i√ßin
    }

    // Ekin Ekme
    plant(cropId) {
        if (this.state !== 'EMPTY') return false;
        this.state = 'SEEDED';
        this.cropId = cropId;
        this.plantTime = Date.now();
        return true;
    }

    // Hasat Etme
    harvest() {
        if (!this.isMature()) return null;
        const harvestedCrop = this.cropId;
        this.state = 'EMPTY';
        this.cropId = null;
        this.plantTime = 0;
        return harvestedCrop;
    }

    // B√ºy√ºm√º≈ü m√º?
    isMature() {
        if (this.state !== 'SEEDED') return false;
        const crop = CROPS[this.cropId];
        return (Date.now() - this.plantTime) >= crop.growthTime;
    }

    // B√ºy√ºme oranƒ± (0.0 - 1.0)
    getProgress() {
        if (this.state !== 'SEEDED') return 0;
        const crop = CROPS[this.cropId];
        const elapsed = Date.now() - this.plantTime;
        return Math.min(elapsed / crop.growthTime, 1.0);
    }
}

// 5. GRID SYSTEM (Oyun D√ºnyasƒ±)
class GridSystem {
    constructor(rows, cols) {
        this.rows = rows;
        this.cols = cols;
        this.tiles = [];
        this.initGrid();
    }

    initGrid() {
        for(let r=0; r<this.rows; r++) {
            this.tiles[r] = [];
            for(let c=0; c<this.cols; c++) {
                this.tiles[r][c] = new Tile(r, c);
            }
        }
    }

    getTile(r, c) {
        if (r >= 0 && r < this.rows && c >= 0 && c < this.cols) {
            return this.tiles[r][c];
        }
        return null;
    }

    // Ekran koordinatlarƒ±nƒ± (px) Grid koordinatlarƒ±na (row, col) √ßevirir
    pixelsToGrid(x, y, offsetX, offsetY) {
        const col = Math.floor((x - offsetX) / CONFIG.TILE_SIZE);
        const row = Math.floor((y - offsetY) / CONFIG.TILE_SIZE);
        return { row, col };
    }

    // JSON Kayƒ±t verisinden gridi y√ºkle
    loadFromData(data) {
        if(!data) return;
        for(let r=0; r<this.rows; r++) {
            for(let c=0; c<this.cols; c++) {
                if(data[r] && data[r][c]) {
                    Object.assign(this.tiles[r][c], data[r][c]);
                }
            }
        }
    }
}
</script><script>
/**
 * PART 3: RENDER, ETKƒ∞LE≈ûƒ∞M VE ANA D√ñNG√ú
 */

// 6. UI MANAGER (Aray√ºz Y√∂neticisi)
const uiManager = {
    game: null, // GameEngine referansƒ±
    
    init(gameInstance) {
        this.game = gameInstance;
        this.updateUI();
    },

    updateUI() {
        const p = this.game.player;
        document.getElementById('uiLevel').innerText = p.level;
        document.getElementById('uiXp').innerText = `${p.xp}/${p.maxXp}`;
        document.getElementById('uiCoin').innerText = p.coins;
        document.getElementById('uiSilo').innerText = `${p.silo.current}/${p.silo.max}`;
    },

    showToast(msg) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.innerText = msg;
        document.getElementById('toastArea').appendChild(toast);
        setTimeout(() => toast.remove(), 2500);
    },

    // Baƒülamsal Men√º (Tarlaya tƒ±klayƒ±nca √ßƒ±kan)
    showContextMenu(tile, screenX, screenY) {
        const menu = document.getElementById('contextMenu');
        menu.innerHTML = '';
        menu.style.display = 'flex';
        menu.style.left = screenX + 'px';
        menu.style.top = screenY + 'px';

        // Eƒüer tarla bo≈üsa -> TOHUM Lƒ∞STESƒ∞
        if (tile.state === 'EMPTY') {
            const seedIcon = document.createElement('div');
            seedIcon.className = 'ctx-item';
            seedIcon.innerText = 'üåæ'; // Varsayƒ±lan tohum (Buƒüday)
            // S√ºr√ºkleme ba≈ülangƒ±cƒ±
            seedIcon.onmousedown = seedIcon.ontouchstart = (e) => {
                this.game.startToolDrag('SEED', 'wheat', e);
                menu.style.display = 'none'; // S√ºr√ºklerken men√ºy√º gizle
            };
            menu.appendChild(seedIcon);
        }
        // Eƒüer ekin varsa ve b√ºy√ºm√º≈üse -> ORAK
        else if (tile.isMature()) {
            const scythe = document.createElement('div');
            scythe.className = 'ctx-item';
            scythe.innerText = '‚öîÔ∏è'; // Orak emojisi
            scythe.onmousedown = scythe.ontouchstart = (e) => {
                this.game.startToolDrag('HARVEST', null, e);
                menu.style.display = 'none';
            };
            menu.appendChild(scythe);
        } else {
            // B√ºy√ºyor...
            menu.style.display = 'none';
        }
    },

    hideContextMenu() {
        document.getElementById('contextMenu').style.display = 'none';
    },

    toggleMarket(show) {
        const modal = document.getElementById('marketModal');
        modal.style.display = show ? 'block' : 'none';
        if(show) this.renderMarket();
    },

    renderMarket() {
        const content = document.getElementById('marketContent');
        content.innerHTML = '';
        const p = this.game.player;

        // Satƒ±labilir √ºr√ºnleri listele
        Object.keys(p.silo.items).forEach(cropId => {
            const count = p.silo.items[cropId];
            if(count > 0) {
                const crop = CROPS[cropId];
                const div = document.createElement('div');
                div.className = 'market-item';
                div.innerHTML = `
                    <div style="font-size:30px">${crop.symbol}</div>
                    <div>${crop.name}</div>
                    <div>Adet: ${count}</div>
                    <div style="color:green; font-weight:bold">${crop.sellPrice} Altƒ±n</div>
                `;
                div.onclick = () => {
                    this.game.sellItem(cropId);
                    this.renderMarket(); // Listeyi yenile
                };
                content.appendChild(div);
            }
        });
        
        if(content.innerHTML === '') content.innerHTML = '<p>Satƒ±lacak √ºr√ºn yok!</p>';
    }
};

// 7. GAME ENGINE (Ana Oyun Motoru)
class GameEngine {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d', { alpha: false }); // Optimizasyon
        this.input = new InputManager(this.canvas);
        
        // Ekran boyutlandƒ±rma
        this.resize();
        window.addEventListener('resize', () => this.resize());

        // Sistemler
        this.grid = new GridSystem(CONFIG.GRID_ROWS, CONFIG.GRID_COLS);
        this.player = new PlayerState();
        
        // Save Y√ºkle
        this.loadGame();

        // Drag Mekaniƒüi Durumlarƒ±
        this.activeTool = null; // 'SEED', 'HARVEST'
        this.activeToolSubtype = null; // 'wheat', 'corn' vb.
        this.dragPath = []; // G√∂rsel efekt i√ßin yol

        // Input Baƒülantƒ±larƒ±
        this.input.on('start', (pos) => this.handleInputStart(pos));
        this.input.on('drag', (pos) => this.handleInputDrag(pos));
        this.input.on('end', () => this.handleInputEnd());

        // Ba≈ülat
        this.lastTime = 0;
        requestAnimationFrame(t => this.loop(t));
        
        // Auto Save
        setInterval(() => this.saveGame(), CONFIG.AUTOSAVE_INTERVAL);
        uiManager.init(this);
    }

    resize() {
        // High DPI Support
        const dpr = window.devicePixelRatio || 1;
        this.canvas.width = window.innerWidth * dpr;
        this.canvas.height = window.innerHeight * dpr;
        this.ctx.scale(dpr, dpr);
        
        // Grid'i ortalamak i√ßin offset hesapla
        this.offsetX = (window.innerWidth - (CONFIG.GRID_COLS * CONFIG.TILE_SIZE)) / 2;
        this.offsetY = (window.innerHeight - (CONFIG.GRID_ROWS * CONFIG.TILE_SIZE)) / 2;
    }

    // --- ETKƒ∞LE≈ûƒ∞M MANTIƒûI (TOOL DRAG) ---
    
    startToolDrag(toolType, subType, event) {
        this.activeTool = toolType;
        this.activeToolSubtype = subType;
        // InputManager'ƒ± manuel tetikle √ß√ºnk√º event context men√ºden geldi
        this.input.handleStart(event);
    }

    handleInputStart(pos) {
        // Eƒüer bir ara√ß se√ßili deƒüilse, tƒ±klanan tarlayƒ± bul
        if (!this.activeTool) {
            const {row, col} = this.grid.pixelsToGrid(pos.x, pos.y, this.offsetX, this.offsetY);
            const tile = this.grid.getTile(row, col);
            
            if (tile) {
                uiManager.showContextMenu(tile, pos.x + this.offsetX/2, pos.y); // Basit pozisyonlama
            } else {
                uiManager.hideContextMenu();
            }
        }
    }

    handleInputDrag(pos) {
        if (this.activeTool) {
            // Raycasting: Parmaƒüƒ±n altƒ±ndaki tarlayƒ± bul
            const {row, col} = this.grid.pixelsToGrid(pos.x, pos.y, this.offsetX, this.offsetY);
            const tile = this.grid.getTile(row, col);
            
            if (tile) {
                this.applyToolToTile(tile);
            }
            
            // Efekt i√ßin yol izi (basit √ßizgi)
            this.dragPath.push(pos);
            if(this.dragPath.length > 10) this.dragPath.shift();
        }
    }

    handleInputEnd() {
        this.activeTool = null;
        this.activeToolSubtype = null;
        this.dragPath = [];
        uiManager.hideContextMenu();
    }

    applyToolToTile(tile) {
        // 1. HASAT MANTIƒûI
        if (this.activeTool === 'HARVEST') {
            if (tile.isMature()) {
                const cropId = tile.harvest();
                if (cropId) {
                    // Depo kontrol√º
                    if (this.player.addItem(cropId, 1)) {
                        this.player.addXp(CROPS[cropId].xp);
                        // Efekt (yazƒ±lƒ±)
                        // Partik√ºl sistemi eklenebilir
                    } else {
                        uiManager.showToast("Depo Dolu!");
                    }
                }
            }
        }
        // 2. EKƒ∞M MANTIƒûI
        else if (this.activeTool === 'SEED') {
            if (tile.state === 'EMPTY') {
                const seedId = this.activeToolSubtype;
                const seedCost = CROPS[seedId].cost; // ƒ∞sterseniz tohum parayla satƒ±labilir
                // Veya envanterden tohum eksiltme mantƒ±ƒüƒ±
                if (this.player.silo.items[seedId] >= 1 || seedCost === 0) {
                     tile.plant(seedId);
                     // Tohum d√º≈ü (eƒüer mantƒ±k buysa)
                }
            }
        }
    }
    
    sellItem(cropId) {
        if(this.player.removeItem(cropId, 1)) {
            const price = CROPS[cropId].sellPrice;
            this.player.coins += price;
            uiManager.updateUI();
            uiManager.showToast(`+${price} Altƒ±n`);
        }
    }

    // --- RENDER D√ñNG√úS√ú ---

    loop(timestamp) {
        const dt = timestamp - this.lastTime;
        this.lastTime = timestamp;

        this.update(dt);
        this.draw();

        requestAnimationFrame(t => this.loop(t));
    }

    update(dt) {
        // Animasyonlar vs buraya
    }

    draw() {
        // 1. Arkaplanƒ± Temizle
        this.ctx.fillStyle = '#8fbc8f'; // √áim rengi
        this.ctx.fillRect(0, 0, this.canvas.width/window.devicePixelRatio, this.canvas.height/window.devicePixelRatio);

        // 2. Grid √áizimi
        const ts = CONFIG.TILE_SIZE;
        
        for(let r=0; r<CONFIG.GRID_ROWS; r++) {
            for(let c=0; c<CONFIG.GRID_COLS; c++) {
                const tile = this.grid.tiles[r][c];
                const x = this.offsetX + c * ts;
                const y = this.offsetY + r * ts;

                // Tarlanƒ±n Kendisi
                this.ctx.fillStyle = (tile.state === 'EMPTY') ? '#795548' : '#5d4037'; // A√ßƒ±k/Koyu Kahve
                this.ctx.fillRect(x + 2, y + 2, ts - 4, ts - 4); // Grid bo≈üluƒüu i√ßin padding
                
                // ƒ∞√ßerik
                if (tile.state !== 'EMPTY' && tile.cropId) {
                    const crop = CROPS[tile.cropId];
                    const progress = tile.getProgress();
                    
                    // Progress Bar (Sadece b√ºy√ºrken)
                    if (progress < 1) {
                        this.ctx.fillStyle = '#ccc';
                        this.ctx.fillRect(x + 5, y + ts - 10, ts - 10, 5);
                        this.ctx.fillStyle = '#76ff03';
                        this.ctx.fillRect(x + 5, y + ts - 10, (ts - 10) * progress, 5);
                        
                        // K√º√ß√ºk emoji
                        this.ctx.font = '20px Arial';
                        this.ctx.fillText(crop.symbol, x + ts/2 - 10, y + ts/2);
                    } 
                    // B√ºy√ºm√º≈ü Ekin
                    else {
                        this.ctx.font = '40px Arial';
                        // Hafif sallanma efekti (canlƒ±lƒ±k i√ßin)
                        const wobble = Math.sin(Date.now() / 200) * 2;
                        this.ctx.fillText(crop.symbol, x + ts/2 - 20, y + ts/2 + 10 + wobble);
                    }
                }
            }
        }

        // 3. Drag Efekti (S√ºr√ºkleme √áizgisi)
        if (this.activeTool && this.dragPath.length > 0) {
            this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            this.ctx.lineWidth = 10;
            this.ctx.lineCap = 'round';
            this.ctx.beginPath();
            this.dragPath.forEach((p, i) => {
                if(i===0) this.ctx.moveTo(p.x, p.y);
                else this.ctx.lineTo(p.x, p.y);
            });
            this.ctx.stroke();
            
            // ƒ∞mle√ß ucuna aracƒ± √ßiz
            const lastPos = this.dragPath[this.dragPath.length-1];
            this.ctx.font = '30px Arial';
            this.ctx.fillText(this.activeTool === 'HARVEST' ? '‚öîÔ∏è' : 'üåæ', lastPos.x, lastPos.y);
        }
    }

    // --- SAVE / LOAD ---
    saveGame() {
        const data = {
            player: this.player,
            grid: this.grid.tiles,
            timestamp: Date.now()
        };
        SaveSystem.save('farmSaveV1', data);
        console.log("Oyun Kaydedildi.");
    }

    loadGame() {
        const data = SaveSystem.load('farmSaveV1');
        if (data) {
            // Player verisini y√ºkle (Object.assign y√ºzeysel kalabilir, manuel set daha g√ºvenli)
            Object.assign(this.player, data.player);
            // Silo itemleri bazen kaybolabilir, kontrol et
            if(!this.player.silo.items) this.player.silo.items = {};
            
            // Grid verisini y√ºkle
            this.grid.loadFromData(data.grid);
            
            uiManager.showToast("Oyun Y√ºklendi!");
        }
    }
}

// OYUNU BA≈ûLAT
window.onload = () => {
    const game = new GameEngine();
};

</script>
</body>
</html>
